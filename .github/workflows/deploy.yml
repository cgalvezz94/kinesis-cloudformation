name: CI/CD Pipeline

permissions:
    id-token: write
    contents: read

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  ### ðŸ”¹ CI: Testing & Validation
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8

      - name: Run Linter
        run: |
          flake8 app/ --max-line-length=100

      #- name: Run Unit Tests
      #  run: |
      #    pytest app/tests/ --disable-warnings -q

  ### ðŸ”¹ CD: Deploy Infra + Lambda Code
  cd:
    needs: ci   # <- CD solo corre si CI pasa
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::302263066270:role/streaming-data-crypto
          aws-region: us-east-1  

      - name: Validate CloudFormation 1
        run: |
          aws cloudformation validate-template --template-body file://iac/infra-basica.yml

      - name: Validate CloudFormation 2
        run: |
          aws cloudformation validate-template --template-body file://iac/infra-secundaria.yml

      - name: Deploy CloudFormation Stack 1
        run: |
          aws cloudformation deploy \
            --template-file iac/infra-basica.yml \
            --stack-name basic-infra \
            --capabilities CAPABILITY_NAMED_IAM

      - name: Package Lambda Code
        run: |
          zip -r function.zip app/ requirements.txt

      - name: Upload Lambda Package to S3
        run: |
          aws s3 cp function.zip s3://mi-bucket-lambdas/function.zip

      - name: Deploy CloudFormation stack
        run: |
          aws cloudformation deploy \
            --template-file iac/infra-secundaria.yml \
            --stack-name real-time-stack \
            --parameter-overrides LambdaCodeS3Bucket=mi-bucket-lambdas LambdaCodeS3Key=function.zip
